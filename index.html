<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart School Bell Panel</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.6)), url("background.jpg");
            background-size: cover;
            background-attachment: fixed;
            color: white;
        }
        /* HEADER */
        header {
            background: rgba(0,0,0,0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .logoSection { display: flex; align-items: center; }
        .logoSection img { height: 70px; margin-right: 15px; }
        .schoolName { font-size: 22px; font-weight: bold; }
        .statusClockBox { display: flex; flex-direction: column; align-items: flex-end; }
        #clock { font-size: 26px; font-weight: bold; }
        #date { font-size: 14px; }
        #espStatus { margin-top: 5px; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; background: gray; transition: 0.3s; }
        
        /* CONTAINER */
        .container { width: 95%; margin: auto; margin-top: 20px; padding-bottom: 80px; }
        .card { background: rgba(255,255,255,0.95); color: black; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); margin-bottom: 20px; }
        input, select { padding: 8px; margin: 5px; border-radius: 6px; border: 1px solid #ccc; }
        button { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; margin: 3px; font-weight: bold; }
        .addBtn { background: #27ae60; color: white; }
        .ringBtn { background: #e67e22; color: white; }
        .deleteBtn { background: #e74c3c; color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        .hidden { display: none; }
        footer { position: fixed; bottom: 10px; right: 10px; background: #1e3d59; color: white; padding: 10px 15px; border-radius: 8px; font-size: 13px; box-shadow: 0 3px 8px rgba(0,0,0,0.5); z-index: 1000; }
        
        @media(max-width:600px) {
            input, select { width: 100%; margin: 5px 0; }
            header { flex-direction: column; align-items: flex-start; }
            .statusClockBox { align-items: flex-start; margin-top: 10px; }
        }
    </style>
</head>
<body>

<header>
    <div class="logoSection">
        <img src="logo.png">
        <div class="schoolName">Sparktron Smart Bell</div>
    </div>
    <div class="statusClockBox">
        <div id="clock">00:00:00</div>
        <div id="date">Loading...</div>
        <div id="espStatus">Checking ESP...</div>
    </div>
</header>

<div class="container">
    <div class="card" id="loginBox">
        <h3>Admin Login</h3>
        <input type="text" id="username" placeholder="Username"><br>
        <input type="password" id="password" placeholder="Password"><br>
        <button class="addBtn" onclick="login()">Login</button>
    </div>

    <div class="card hidden" id="dashboard">
        <h3>Add Bell Schedule</h3>
        <select id="day">
            <option>Sunday</option>
            <option>Monday</option>
            <option>Tuesday</option>
            <option>Wednesday</option>
            <option>Thursday</option>
            <option>Friday</option>
            <option>Saturday</option>
        </select>
        <input type="number" id="hour" min="0" max="23" placeholder="Hour">
        <input type="number" id="minute" min="0" max="59" placeholder="Minute">
        <input type="number" id="duration" placeholder="Duration (sec)">
        <br>
        <label><input type="checkbox" id="repeatNext"> Repeat Next Day</label>
        <label><input type="checkbox" id="repeatWeek"> Repeat Full Week</label>
        <br>
        <button class="addBtn" onclick="addSchedule()">Upload Schedule</button>
        <button class="ringBtn" onclick="remoteRing()">ðŸ”” Ring Now (Manual)</button>

        <h3>Weekly Time Table</h3>
        <table id="table">
            <tr>
                <th>Day</th>
                <th>Time (24H)</th>
                <th>Duration</th>
                <th>Action</th>
            </tr>
        </table>
    </div>
</div>

<footer>
    Developed by Vishwajeet Jadhav <br> ðŸ“ž9322244959 <br> ðŸ“§jadhavvishwajeet94@gmail.com
</footer>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
/* ðŸ”¥ YOUR FIREBASE CONFIG */
const firebaseConfig = {
    apiKey: "AIzaSyCkl4p4SnS84EzLIyIjTk5euJH9lx9FVSI",
    authDomain: "sparktrontechbell.firebaseapp.com",
    databaseURL: "https://sparktrontechbell-default-rtdb.firebaseio.com",
    projectId: "sparktrontechbell",
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* CLOCK (IST Compatible) */
function updateClock(){
    const now = new Date();
    document.getElementById("clock").innerText = now.toLocaleTimeString('en-IN', { hour12: false });
    document.getElementById("date").innerText = now.toLocaleDateString('en-IN', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}
setInterval(updateClock, 1000);
updateClock();

/* LOGIN */
function login(){
    if(document.getElementById("username").value === "srjadhav" && document.getElementById("password").value === "7588"){
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
    } else {
        alert("Wrong login");
    }
}

/* ESP STATUS TRACKER */
database.ref("/SchoolBell/espStatus").on("value", (snapshot) => {
    const lastUpdate = snapshot.val();
    const statusDiv = document.getElementById("espStatus");
    if(!lastUpdate) return;
    
    // Check if the difference is less than 20 seconds
    const diff = Date.now() - lastUpdate;
    if(diff < 20000){
        statusDiv.style.background = "green";
        statusDiv.innerText = "ðŸŸ¢ ESP32 ONLINE";
    } else {
        statusDiv.style.background = "red";
        statusDiv.innerText = "ðŸ”´ ESP32 OFFLINE";
    }
});

/* MANUAL TRIGGER */
function remoteRing() {
    database.ref("/SchoolBell/manualTrigger").set(true);
    alert("Manual Ring Command Sent!");
}

/* LOAD TABLE DAY-WISE & TIME SORTED */
const dayOrder = { "Sunday":0, "Monday":1, "Tuesday":2, "Wednesday":3, "Thursday":4, "Friday":5, "Saturday":6 };

database.ref("/SchoolBell/schedule").on("value", (snapshot) => {
    let table = document.getElementById("table");
    table.innerHTML = "<tr><th>Day</th><th>Time (24H)</th><th>Duration</th><th>Action</th></tr>";
    
    let dataArray = [];
    snapshot.forEach((child) => {
        let data = child.val();
        data.key = child.key;
        dataArray.push(data);
    });

    /* SORTING */
    dataArray.sort((a,b) => {
        if(dayOrder[a.day] !== dayOrder[b.day]) return dayOrder[a.day] - dayOrder[b.day];
        if(a.hour !== b.hour) return a.hour - b.hour;
        return a.minute - b.minute;
    });

    /* DISPLAY */
    dataArray.forEach((data) => {
        let row = table.insertRow(-1);
        row.insertCell(0).innerHTML = data.day;
        row.insertCell(1).innerHTML = String(data.hour).padStart(2,'0') + ":" + String(data.minute).padStart(2,'0');
        row.insertCell(2).innerHTML = data.duration + " sec";
        row.insertCell(3).innerHTML = `<button class='deleteBtn' onclick="deleteSchedule('${data.key}')">Delete</button>`;
    });
});

/* ADD SCHEDULE */
const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

function addSchedule(){
    let day = document.getElementById("day").value;
    let hour = parseInt(document.getElementById("hour").value);
    let minute = parseInt(document.getElementById("minute").value);
    let duration = parseInt(document.getElementById("duration").value);
    let repeatNext = document.getElementById("repeatNext").checked;
    let repeatWeek = document.getElementById("repeatWeek").checked;

    if(isNaN(hour) || isNaN(minute) || isNaN(duration)){
        alert("Fill all fields correctly");
        return;
    }

    function pushToFirebase(d) {
        database.ref("/SchoolBell/schedule").push({
            day: d, hour: hour, minute: minute, duration: duration
        });
    }

    if(repeatWeek){
        days.forEach(d => pushToFirebase(d));
    } else {
        pushToFirebase(day);
        if(repeatNext){
            let nextIndex = (days.indexOf(day) + 1) % 7;
            pushToFirebase(days[nextIndex]);
        }
    }
    alert("Schedule Uploaded Successfully âœ…");
}

/* DELETE */
function deleteSchedule(key){
    if(confirm("Delete this entry?")) {
        database.ref("/SchoolBell/schedule/" + key).remove();
    }
}
</script>
</body>
</html>
